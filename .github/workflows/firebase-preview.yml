name: Firebase Hosting Preview (static export)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy-preview:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps
        run: npm ci

      - name: Build Next.js
        run: npm run build

      - name: Export static site (optional)
        run: |
          # Try a static export to `out/`. This requires your Next.js app to support static export.
          # If your app cannot be exported statically (App Router SSR features), this step may fail.
          npx next export || true

      - name: Install firebase-tools
        run: npm install -g firebase-tools@

      - name: Deploy to Firebase Hosting preview channel
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          FIREBASE_PROJECT: ${{ secrets.FIREBASE_PROJECT }}
        run: |
          # Ensure FIREBASE_PROJECT is set in repo secrets (your Firebase project id)
          if [ -z "$FIREBASE_PROJECT" ]; then echo "FIREBASE_PROJECT secret is not set"; exit 1; fi

          # Use the `out` directory produced by `next export`. If your project uses a different
          # static output or you pre-build static assets elsewhere, update the path.
          PUBLIC_DIR=out
          if [ ! -d "$PUBLIC_DIR" ]; then
            echo "Directory '$PUBLIC_DIR' not found â€” static export likely failed."
            echo "If your app requires SSR, consider deploying to Cloud Run instead (needs GCP credentials)."
            exit 1
          fi

          # Create a preview channel named by the branch + run id and deploy
          CHANNEL_NAME="preview-${{ github.ref_name }}-${{ github.run_id }}"
          firebase hosting:channel:deploy "$CHANNEL_NAME" --project "$FIREBASE_PROJECT" --token "$FIREBASE_TOKEN" --public "$PUBLIC_DIR" --message "Preview from ${{ github.ref }} (run ${{ github.run_id }})"

      - name: Output preview URL
        env:
          FIREBASE_PROJECT: ${{ secrets.FIREBASE_PROJECT }}
        run: |
          # Prints the URL for the last preview channel for convenience
          firebase hosting:channel:list --project "$FIREBASE_PROJECT" --json | jq -r '.[] | select(.status=="ACTIVE") | .url' | head -n 1 || true
